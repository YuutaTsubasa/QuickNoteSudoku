<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Quick Note Sudoku</title>
  <link rel="stylesheet" href="assets/icons/phosphor/style.css" />
  <style>
    @font-face {
      font-family: 'Noto Sans TC';
      src: url('./fonts/NotoSansTC-Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }

    @font-face {
      font-family: 'Noto Sans TC';
      src: url('./fonts/NotoSansTC-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: bold;
    }

    @font-face {
      font-family: 'Source Han Serif TC';
      src: url('./fonts/SourceHanSerifTC-Regular.otf') format('opentype');
      font-weight: 400;
      font-style: normal;
    }

    @font-face {
      font-family: 'Source Han Serif TC';
      src: url('./fonts/SourceHanSerifTC-Bold.otf') format('opentype');
      font-weight: 700;
      font-style: bold;
    }

    @font-face {
      font-family: 'Source Code Pro';
      src: url('./fonts/SourceCodePro-Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }

    @font-face {
      font-family: 'Source Code Pro';
      src: url('./fonts/SourceCodePro-Bold.ttf') format('truetype');
      font-weight: 700;
      font-style: bold;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      font-family: 'Source Code Pro', 'Noto Sans TC', sans-serif;
      width: 100%;
      height: 100%;
      background-color: #1e293b; /* slate-900 */
      overflow-x: hidden;
    }

    .screen {
      display: none;
      width: 100vw;
      min-height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      padding-top: env(safe-area-inset-top);

      &.active {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    }

    #splash_screen {
      background-color: #1e293b; /* slate-900 */
      color: white;
      justify-content: center;
    }

    .logo-box {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;

      & img {
        width: 50%;
      }

      &.enter {
          transform: translateX(20px);
          opacity: 0;
          animation: enterAnimation 0.5s ease-out 0.4s forwards;
      }
    }

    @keyframes enterAnimation {
      from {
          transform: translateX(20px);
          opacity: 0;
      }
      to {
          transform: translateX(0);
          opacity: 1;
      }
    }

    @keyframes leaveAnimation {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(-20px);
            opacity: 0;
        }
    }

    /* 整個主頁背景色不變，保留漸層 */
    #main_page {
      background: linear-gradient(to top right, #1e293b, #334155);
      color: #0f172a;
      overflow: hidden;
    }

    #gameplay_page {
      transform: translateX(20px);
      opacity: 0;
      animation: enterAnimation 0.5s ease-out 0s forwards;

      background: linear-gradient(to top, #e0e0e0 0%, #ffffff 30%, #ffffff 100%);
      width: 100%;
      padding-bottom: 10px;
    }

    /* 主容器 */
    .main-lower {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: calc(50% + 200px);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeUp 0.6s ease-out 0.3s forwards;
    }

    @keyframes fadeUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 跑馬燈下方顯示 */
    .sudoku-marquee {
      width: 100%;
      height: 200px;
      background: transparent;
      z-index: 1;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      top: 150px;

      &.top {
        position: fixed;
        height: 120px;
        top: 0px;
        transform: translateX(20px);
        opacity: 0;
        animation: enterAnimation 0.8s ease-out 0.2s forwards;
      }
    }

    .scroll-text {
      font-size: 150px;
      font-weight: bold;
      -webkit-text-fill-color: transparent;
      -webkit-text-stroke-width: 1px;
      -webkit-text-stroke-color: white;
      padding: 0.25rem 1rem;
      animation: scrollText 40s linear infinite;
      white-space: nowrap;
    }

    @keyframes scrollText {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-50%);
      }
    }

    /* 按鈕區 */
    .button-area {
      padding-top: 100px;
      flex: 1;
      background: white;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      z-index: 2;
      position: relative;
      clip-path: polygon(0 100px, 0 100%, 100% 100%, 100% 0%);
    }

    .button-area button {
      width: 80%;
      height: 50px;
      text-align: left;
      padding-left: 25px;
    }

    /* 背景圖與角色圖層容器 */
    .scene-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      overflow: hidden;
    }

    .fancy-button {
      position: relative;
      background: linear-gradient(145deg, #0080ff, #0040ff);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      color: white;
      font-weight: bold;
      padding: 0.5rem 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      font-size: 1.2rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
      transition: transform 0.1s ease;
      cursor: pointer;
    }

    .fancy-button.active {
      background: linear-gradient(145deg, #fbff00, #fffb00);
      color: black;
    }

    .fancy-button.checked {
      background: linear-gradient(145deg, #01a532, #016d2e);
    }

    .fancy-button:hover, .fancy-button.active:hover,
    .fancy-button#removeAllNotesBtn:hover,
    .fancy-button#pauseBtn:hover  {
      background-image: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 1.0) 0px,
        rgba(255, 255, 255, 1.0) 2px,
        rgba(230, 230, 230, 1.0)  2px,
        rgba(230, 230, 230, 1.0)  4px
      ); 
      color: black;
    }

    .fancy-button:active, .fancy-button.active:active,
    .fancy-button#removeAllNotesBtn:active,
    .fancy-button#pauseBtn:active  {
      background-image: repeating-linear-gradient(
        45deg,
        rgba(255, 255, 255, 1.0) 0px,
        rgba(255, 255, 255, 1.0) 2px,
        rgba(230, 230, 230, 1.0)  2px,
        rgba(230, 230, 230, 1.0)  4px
      );
      color: black;
    }

    .fancy-button#removeAllNotesBtn {
      background: linear-gradient(145deg, #c51e1e, #b40808);
    }

    .fancy-button#pauseBtn {
      background: linear-gradient(145deg, #222222, #080808);
    }

    /* 背景圖鋪滿且置中 */
    .scene-layer .bg {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      z-index: 0;
      opacity: 0;
      filter: blur(5px) brightness(0.9); /* 模糊 + 變暗 */
      animation: enterAnimation 0.8s ease-out 0.2s forwards;
    }

    #errors:not([data-content="0"]){
      color: rgb(247, 8, 8)
    }

    /* 角色圖置中且高為整個畫面高 */
    .scene-layer .char {
      position: absolute;
      width: 100%;
      height: 100%;
      background: center;
      transform: translateX(-50%) translateY(20px);
      object-fit: contain;
      z-index: 1;
      opacity: 0;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5)); /* 加陰影 */
      animation: enterAnimation 0.8s ease-out 0.4s forwards;
    }

    /* 齒輪鈕 */
    .settings-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background-color: rgba(255, 255, 255, 0.8);
      border: none;
      font-size: 1.5rem;
      border-radius: 50%;
      padding: 0.5rem;
      cursor: pointer;
      z-index: 2;
      transition: background-color 0.2s ease;
    }

    .settings-button:hover {
      background-color: rgba(255, 255, 255, 1);
    }

    .has-grid::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
      background-size: 20px 20px;
      pointer-events: none;
      z-index: -1;
    }

    .control-panel {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1e1e1e;
      color: #ffffff;
      padding: 1rem;
      margin: 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      flex-wrap: wrap;
      gap: 10px;
    }

    @media (max-width: 400px) {
      .control-panel {
        display: grid;
        grid-template-rows: 0.5fr 1fr;
        grid-template-columns: 1fr 1fr;
      }
    }

    .info-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
    }

    .info-block .label {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .info-block .value {
      font-size: 1.8rem;
      font-weight: bold;
    }

    .control-right {
      grid-column: span 2;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .control-right button {
      text-align: left;
      width: 100%;
    }

    #number-pad {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #number-pad button {
      font-family: "Source Code Pro", monospace;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      font-size: 18px;
      padding: 0;
      cursor: pointer;
      border: 1px solid #aaa;
      border-radius: 6px;
    }

    @keyframes flash {
      0%, 100% { background-color: #fff59d; }
      50% { background-color: #ffee58; }
    }

    #general-popup {
      transform: translateX(20px);
      opacity: 0;
      animation: enterAnimation 0.5s ease-out 0s forwards;
    }

    .popup-backdrop {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    .popup-background {
      background-color: white;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .popup-box {
      width: 100%;
      max-width: 600px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .popup-title {
      font-size: 1.5rem;
      font-weight: bold;
      padding: 1rem;
      text-align: center;
      font-family: 'Source Han Serif TC', sans-serif;
    }

    .popup-content {
      padding: 1rem;
      font-weight: bold;
      font-size: 1rem;
      line-height: 1.5;
    }

    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      flex-wrap: wrap;
    }

    /* 整體盤面容器 */
    #sudoku-board {
      display: grid;
      width: 90vw;
      max-width: 540px;
      aspect-ratio: 1 / 1;
      grid-template-columns: repeat(9, 1fr);
      grid-template-rows: repeat(9, 1fr);
      gap: 1px;

      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      background: #ffffff;
      padding: 4px;
      border: 2px solid #bbb;
    }

    /* 每個格子 */
    .cell {
      position: relative;
      border: 1px solid #ddd;
      background-color: #fff;
      text-align: center;
      cursor: pointer;
      box-sizing: border-box;
      transition: background 0.2s ease;
    }

    /* 鎖定的初始數字 */
    .cell.filled {
      background: linear-gradient(145deg, #0080ff, #0040ff);
      font-weight: bold;
      color: white;
    }

    /* 數字顯示 */
    .cell .value {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 45px;
      font-weight: bold;
      z-index: 2;
      font-family: 'Source Code Pro', monospace;
    }
    
    .cell .value.locked {
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
    }

    .cell .value.user {
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
    }

    /* 筆記模式 */
    .notes {
      position: absolute;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      font-size: 12px;
      color: #555;
      z-index: 1;
      pointer-events: none;
      font-family: 'Source Code Pro', monospace;
    }

    .notes div {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1px;
    }

    .notes .single,
    .notes .unique-note {
      color: #2196f3 !important;
      font-weight: bold;
    }

    /* 選中格子 */
    .cell.selected {
      outline: 2px solid #0077cc;
      z-index: 2;
      background: #e6f4ff;
    }

    /* 筆記模式開啟時 */
    .cell.note-mode {
      background-color: #e0f7e9 !important;
    }

    /* 錯誤格子 */
    .cell.error,
    .cell.error .value.user {
      border: 2px solid red !important;
      color: red !important;
    }

    /* 高亮格子 */
    .cell.highlight {
      background: #fff000 !important;
      animation: flash 0.4s ease-in-out;
      color: black !important;
    }

    .cell.highlight .value {
      color: black !important;
    }

    /* 九宮格粗線條 */
    .cell.row-0,
    .cell.row-3,
    .cell.row-6 { border-top: 2px solid #000; }

    .cell.col-0,
    .cell.col-3,
    .cell.col-6 { border-left: 2px solid #000; }

    .cell.row-8 { border-bottom: 2px solid #000; }
    .cell.col-8 { border-right: 2px solid #000; }

    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }

      #number-pad button {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }

      .cell .value {
        font-size: calc(5vw + 10px);
      }

      .notes {
        font-size: calc(2.5vw);
        line-height: 2vw;
      }

      .notes div[style*="font-weight: bold"] {
        font-size: calc(2.5vw + 2px);
        color: black;
      }
    }

    .topbar {
      width: 100%;
      margin-top: 5px;
      height: 60px;
      display: flex;
      align-items: center;
      position: relative;
      z-index: 10;
    }

    .topbar .back-button {
      background: none;
      border: none;
      color: #1e293b; /* slate-900 */
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      padding: 0.5rem;
      margin-right: 1rem;
    }

    .topbar .back-button:hover {
      color: #0284c7;
    }

    .topbar-title {
      font-family: "Source Han Serif TC", "思源宋體", serif;
      font-size: 2rem;
      color: #1e293b;
      flex-grow: 1;
    }

    #achievements-page {
      color: #222;
      font-family: "Noto Sans TC", sans-serif;
      background: linear-gradient(to top, #e0e0e0 0%, #ffffff 30%, #ffffff 100%);
      width: 100vw;
      min-height: 100vh;
      transform: translateX(20px);
      opacity: 0;
      animation: enterAnimation 0.5s ease-out 0s forwards;
    }

    .achievement-section {
      margin-bottom: 2rem;
    }

    .stats-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 1rem 0;
      padding: 5px;
      align-items: center;
      justify-content: center;
    }

    .stats-grid > div {
      width: 150px;
      background: #111;
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      text-align: center;
      color: white;
    }

    .stats-grid > div > small {
      font-size: 0.8rem;
      color: #aaa;
    }

    .stats-grid > div > div {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 0.25rem;
    }

    .achievement-tabs {
      display: flex;
      justify-content: center;
      margin-top: 0.5rem;
      padding: 0.5rem;
      gap: 10px;
    }

    .tab-btn {
      flex: 1;
      padding: 0.5rem;
      background: none;
      border: none;
      font-weight: bold;
      font-size: 1rem;
      color: black;
      border: black 1px solid;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tab-btn.active {
      border: #c0e710 2px solid;
      background: #c0e710;
      color: #000;
    }

    .record-item {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1e1e1e;
      color: #ffffff;
      padding: 1rem;
      margin: 1rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      flex-wrap: wrap;
    }

    .mini-sudoku {
      display: grid;
      grid-template-rows: repeat(9, 1fr);
      grid-template-columns: repeat(9, 1fr);
      width: 90px;
      height: 90px;
      background: #fff;
      border: 1px solid black;
      margin-right: 1rem;
      font-size: 8px;
      line-height: 6px;
      align-items: center;
      justify-content: center;
    }

    .mini-sudoku div {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mini-row {
      display: contents;
    }

    .mini-row span {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      width: 100%;
      height: 100%;
      border: 0.5px solid #eee;
    }

    .info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .info .title {
      font-family: 'Source Han Serif TC';
      font-size: 1.3rem;
      font-weight: bold;
      color: #bebebe;
    }

    .info button {
      margin-top: 10px;
    }

    *.leave, screen.leave, #splash_screen.leave, #main_page.leave,
    #gameplay_page.leave, #achievements-page.leave, #general-popup.leave {
      transform: translateX(0);
      opacity: 1;
      animation: leaveAnimation 0.5s ease-out 0s forwards;
    }
  </style>
</head>
<body>
  <audio id="main_page_bgm" src="assets/sounds/mainpage.mp3" loop="true" preload="auto"></audio>
  <audio id="gameplay_page_bgm" src="assets/sounds/gameplay.mp3" loop="true" preload="auto"></audio>
  <audio id="achievements-page_bgm" src="assets/sounds/achievement.mp3" loop="true" preload="auto"></audio>

  <!-- Splash Screen -->
  <div id="splash_screen" class="screen active">
    <div class="logo-box enter"><img src="assets/logo.png" alt="Logo" /></div>
  </div>

  <!-- Main Page -->
  <div id="main_page" class="screen">
    <div class="scene-layer">
      <img id="bg-image" class="bg" alt="Background"/>
      <div class="sudoku-marquee top">
        <div class="scroll-text">QUICK NOTE SUDOKU QUICK NOTE SUDOKU QUICK NOTE SUDOKU QUICK NOTE SUDOKU QUICK NOTE SUDOKU</div>
      </div>
      <img id="char-image" class="char" alt="Character"/>
      <!-- <button class="settings-button" onclick="openSettings()">⚙️</button> -->
    </div>
    <div class="main-lower">
      <div class="sudoku-marquee">
        <div class="scroll-text">QUICK NOTE SUDOKU QUICK NOTE SUDOKU QUICK NOTE SUDOKU QUICK NOTE SUDOKU QUICK NOTE SUDOKU</div>
      </div>
      <div class="button-area has-grid">
        <button id="today-button" class="fancy-button" onclick="startPuzzle(TODAY_MODE)">今日數獨</button>
        <button class="fancy-button" onclick="startPuzzle(FREE_MODE)">自由遊玩</button>
        <button class="fancy-button" onclick="showCustomPopup()">自訂遊玩</button>
        <button class="fancy-button" onclick="renderAchievements()">成就</button>
      </div>
    </div>
  </div>

  <!-- Game Play Page -->
  <div id="gameplay_page" class="screen has-grid">
    <div class="topbar">
      <button class="back-button" onclick='
        showPopup({
          title: "確認離開",
          content: "遊戲尚未完成，確定要離開嗎？",
          buttons: [
            {
              text: "取消",
              onClick: () => { return false; }
            },
            {
              text: "確定離開",
              onClick: () => {
                goToScene(main);
                return false;
              }
            }
          ]
        })'>←</button>
      <h1 class="topbar-title"></h1>
    </div>
    <div id="game-controls" class="control-panel">
      <div class="info-block">
        <div class="label">時間</div>
        <div class="value" id="timer">02:00</div>
      </div>
      <div class="info-block">
        <div class="label">錯誤</div>
        <div class="value" data-content="0" id="errors">0</div>
      </div>
      <div class="control-right">
        <button id="noteModeBtn" class="fancy-button"><i class="ph ph-note icon"></i>筆記</button>
        <button id="fillNotesBtn" class="fancy-button"><i class="ph ph-pen icon"></i>自動</button>
        <button id="removeAllNotesBtn" class="fancy-button"><i class="ph ph-eraser icon"></i>清除</button>
        <button id="pauseBtn" class="fancy-button"><i class="ph ph-pause icon"></i>暫停</button>
      </div>
    </div>
    <div id="sudoku-board"></div>
    <div id="number-pad">
      <!-- 1~9 按鈕 -->
      <button class="fancy-button" data-num="1">1</button>
      <button class="fancy-button" data-num="2">2</button>
      <button class="fancy-button" data-num="3">3</button>
      <button class="fancy-button" data-num="4">4</button>
      <button class="fancy-button" data-num="5">5</button>
      <button class="fancy-button" data-num="6">6</button>
      <button class="fancy-button" data-num="7">7</button>
      <button class="fancy-button" data-num="8">8</button>
      <button class="fancy-button" data-num="9">9</button>
    </div>
  </div>

  <div id="achievements-page" class="screen has-grid">
    <div class="topbar">
      <button class="back-button" onclick="goToScene(main)">←</button>
      <h1 class="topbar-title">成就紀錄 <span style="font-size: 1rem">Achievements</span></h1>
    </div>
    <div class="achievement-tabs">
      <button class="tab-btn active" data-tab="stats"><i class="ph ph-chart-bar"></i> 統計</button>
      <button class="tab-btn" data-tab="today"><i class="ph ph-calendar-blank"></i> 今日</button>
      <button class="tab-btn" data-tab="free"><i class="ph ph-infinity"></i> 自由</button>
      <button class="tab-btn" data-tab="custom"><i class="ph ph-pencil-simple"></i> 自訂</button>
    </div>
    <div class="achievement-section" id="stats-section">
      <div class="stats-grid">
        <div><small>完成數獨數</small><div id="stat-total">0</div></div>
        <div><small>完美完成數獨數</small><div id="stat-perfect">0</div></div>
        <div><small>最快完成時間</small><div id="stat-min-time">0:00</div></div>
        <div><small>最慢完成時間</small><div id="stat-max-time">0:00</div></div>
        <div><small>平均完成時間</small><div id="stat-avg-time">0:00</div></div>
        <div><small>最少錯誤數</small><div id="stat-min-errors">0</div></div>
        <div><small>最多錯誤數</small><div id="stat-max-errors">0</div></div>
        <div><small>平均錯誤數</small><div id="stat-avg-errors">0.00</div></div>
      </div>
    </div>
    <div class="achievement-section" id="today-section">
      <div class="achievement-list" id="today-list"></div>
    </div>

    <div class="achievement-section" id="free-section">
      <div class="achievement-list" id="free-list"></div>
    </div>

    <div class="achievement-section" id="custom-section">
      <div class="achievement-list" id="custom-list"></div>
    </div>
  </div>

  <div id="general-popup" class="popup-backdrop" style="display: none;">
    <div class="popup-background">
      <div class="popup-box">
        <div class="popup-title" id="popup-title">標題</div>
        <div class="popup-content" id="popup-content">內容</div>
        <div class="popup-buttons" id="popup-buttons">
          <!-- 動態產生按鈕 -->
        </div>
      </div>
    </div>
  </div>

  <script>
    const TODAY_MODE = "today";
    const FREE_MODE = "free";
    const CUSTOM_MODE = "custom";

    const splash = document.getElementById('splash_screen');
    const main = document.getElementById('main_page');
    const gameplay = document.getElementById('gameplay_page');
    const achievements = document.getElementById('achievements-page');
    const allPages = {
        splash,
        main,
        gameplay,
        achievements
    };
    const animationReplayElementQueries = {
      "#main_page" : {
        ".main-lower": {
          ".scroll-text": null 
        }
      }
    }
    function replayAnimationWorkaround(root, tree) {
      for (let query in tree) {
        root.querySelectorAll(query)
          .forEach(element => {
            element.style = "display: none";
            requestAnimationFrame(() => {
              element.style = "";
              if (tree[query]) replayAnimationWorkaround(element, tree[query]);
            });
          });
      }
    }

    function playClickSound() {
      const sound = new Audio('assets/sounds/click.mp3');
      sound.play();
    }

    let randomFunc = Math.random;
    let mode, cachedToday;

    window.addEventListener('DOMContentLoaded', async () => {
      loadSceneImages();
      document.querySelectorAll("button")
        .forEach(button => {
          button.addEventListener("click", function(event){
            setTimeout(() => btn.blur(), 0); 
            playClickSound();
          })
        });

      await runSplashScene();
      await goToScene(main);

      setInterval(() => {
        updateTodayButton();
      }, 1000);
    });

    function updateTodayButton(){
      const todayButton = main.querySelector("#today-button");
      const todayStr = getToday();
      const isTodaySolved = loadSaveData().today[todayStr];

      todayButton.innerHTML = `今日數獨 <small>${todayStr}</small>`;
      if (isTodaySolved &&
          !todayButton.classList.contains("checked")){
        todayButton.classList.add("checked");
      } else if (!isTodaySolved &&
          todayButton.classList.contains("checked")) {
        todayButton.classList.remove("checked");
      }
    }

    async function runSplashScene(){
      await wait(1500);
      await new Promise((resolve) => {
        showPopup({
          title: "快速筆記數獨", 
          content:`
            <p>「快速筆記數獨」顧名思義就是可以讓遊戲自己幫你做好筆記的數獨遊戲方式，遊玩過程會比以往的數獨遊戲來得快，準備好也來體驗了嗎？</p>
            <br/>
            <ul style="list-style-position: inside;">
              <li>程式：<small>悠太翼</small></li>
              <li>程式輔助：<small>ChatGPT</small></li>
              <li>背景圖片：<small>Midjourney</small></li>
              <li>音樂：<small>Suno AI</small></li>
              <li>音效：<small>魔王魂</small></li>
            </ul>
          `,
          buttons: [{
            text: "進入遊戲",
            onClick: () => {
              resolve();
              return false;
            }
          }]});
      });
      await wait(500);
      var logoBox = splash.querySelector('.logo-box');
      logoBox.classList.remove('enter');
      logoBox.classList.add('leave');
    }

    function showCustomPopup() {
      showPopup({
        title: "自訂盤面",
        content: `
          <div id="custom-warning" style="color:#b00020; display:none; margin-bottom:0.5rem; font-size:0.9rem;"></div>
          <textarea id="customPuzzleInput" rows="9" style="width: 100%; resize: none; font-size: 20px" placeholder="請輸入 9 行，每行 9 個數字"></textarea>
        `,
        buttons: [
          { text: "取消", onClick: () => {} },
          { text: "開始遊玩", onClick: () => handleCustomGameStart() }
        ]
      });

      function showWarning(msg) {
        const warn = document.getElementById("custom-warning");
        if (warn) {
          warn.textContent = msg;
          warn.style.display = "block";
        }
      }

      function handleCustomGameStart() {
        const input = document.getElementById("customPuzzleInput").value.trim();
        const lines = input.split('\n');
        if (lines.length !== 9) {
          showWarning("請輸入 9 行數字！");
          return true;
        }

        try {
          const puzzle = lines.map(line => {
            const row = line.trim().replace(/[\s,]+/, "").split("").map(Number);
            if (row.length !== 9 || row.some(n => isNaN(n) || n < 0 || n > 9)) {
              throw new Error();
            }
            return row;
          });

          const solution = solveSudoku(puzzle);
          if (!solution) {
            showWarning("無法解出此題，請確認格式正確且有解！");
            return true;
          }

          hidePopup();
          startPuzzle(CUSTOM_MODE, puzzle);
          return false;
        } catch {
          showWarning("格式錯誤，請確認每行都是 9 個 0~9 的數字");
          return true;
        }
      }
    }

    function toLocalISOString(date) {
      const tzOffset = date.getTimezoneOffset() * 60000; // Offset in milliseconds
      const localTime = new Date(date.getTime() - tzOffset);
      return localTime.toISOString().slice(0, -1); // Remove the 'Z' at the end
    }

    function getToday(){
      return toLocalISOString(new Date()).split("T")[0];
    }

    async function startPuzzle(selectedMode, selectedPuzzle) {
      mode = selectedMode;
      if (mode === TODAY_MODE) {
        cachedToday = getToday(); // e.g., 2025-07-20
        if (loadSaveData().today[cachedToday]){
          showPopup({
            title: "今日數獨",
            content: "今日數獨已解完，明日再來玩吧！",
            buttons: [{
              text: "確認",
              onClick: () => false
            }]
          });
          return;
        }

        const seed = seedFromString(cachedToday); // 把字串轉成整數種子
        const rand = mulberry32(seed);

        function mulberry32(a) {
          return function () {
            var t = (a += 0x6d2b79f5);
            t = Math.imul(t ^ (t >>> 15), t | 1);
            t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
            return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
          };
        }

        function seedFromString(str) {
          let hash = 0;
          for (let i = 0; i < str.length; i++) {
            hash = (hash << 5) - hash + str.charCodeAt(i);
            hash |= 0; // Convert to 32bit integer
          }
          return hash;
        }

        randomFunc = rand;
      }
      else if (mode === FREE_MODE) {
        randomFunc = Math.random;
      }

      document.querySelector(".topbar-title")
        .innerHTML = mode === TODAY_MODE
          ? "今日數獨 <span style='font-size: 1rem'>Today's Sudoku</span>"
          : mode === FREE_MODE
            ? "自由遊玩 <span style='font-size: 1rem'>Free Play</span>"
            : mode === CUSTOM_MODE
              ? "自訂遊玩 <span style='font-size: 1rem'>Custom Play</span>"
              : "";

      goToScene(gameplay);
      if (mode === CUSTOM_MODE){
        startNewGame(selectedPuzzle);
      }
      else {
        startNewGame();
      }
    }

    function loadSceneImages() {
      const bg = localStorage.getItem("bg") || "./assets/backgrounds/0.png";
      const char = localStorage.getItem("char") || "./assets/characters/0/neutral.png";
      const sound = new Audio('assets/sounds/click.mp3');
      sound.preload = "auto";

      document.getElementById("bg-image").src = bg;
      document.getElementById("char-image").src = char;
    }

    function openSettings() {
      alert("這裡之後會開啟設定頁喔！");
    }

    async function goToScene(scene){
      Object.values(allPages).filter(page => page.classList.contains("active"))
        .forEach(page => page.classList.add("leave"));

      await wait(500);

      for (let pageName in allPages){
        let page = allPages[pageName];
        if (pageName !== scene && page !== scene)
        {
          page.classList.remove('active');
          var bgm = document.getElementById(`${page.id}_bgm`);
          if (bgm) {
            bgm.pause();
            bgm.currentTime = 0;
          }
          continue;
        }
        page.classList.add('active');
        replayAnimationWorkaround(page, animationReplayElementQueries[`#${page.id}`]);
        
        document.getElementById(`${page.id}_bgm`)
          ?.play();
      }

      window.scrollTo({
        top: 0
      });
      loadedTabs.clear();
      Object.values(allPages).filter(page => page.classList.contains("leave"))
        .forEach(page => page.classList.remove("leave"));
    }

    function wait(ms) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          console.log("Done waiting");
          resolve(ms)
        }, ms)
      })
    }

    const board = document.getElementById('sudoku-board');
    const noteModeBtn = document.getElementById('noteModeBtn');
    const numberPad = document.getElementById('number-pad');

    let isNoteMode = false;
    let selectedCell = null;

    let puzzle = [];
    let solution = [];

    let errorCount = 0;
    let startTime = null;
    let timerInterval = null;

    const timerDisplay = document.getElementById('timer');
    const errorDisplay = document.getElementById('errors');

    function createCell(row, col, value) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.classList.add(`row-${row}`, `col-${col}`);
      cell.dataset.row = row;
      cell.dataset.col = col;

      if (value > 0) {
        cell.innerHTML = `<div class="value locked">${value}</div>`;
        cell.dataset.value = value;
        cell.classList.add("filled", "locked");
      } else {
        cell.dataset.value = '';
      }

      board.appendChild(cell);

      cell.addEventListener('click', () => {
        if (selectedCell) selectedCell.classList.remove('selected');
        selectedCell = cell;
        cell.classList.add('selected');

        // 新增：點選已填格也觸發筆記清除
        if (cell.classList.contains("filled")) {
          const value = parseInt(cell.dataset.value);
          if (!isNaN(value)) {
            removeNotesAround(cell, value);
          }
        }

        updateHighlights();
      });
    }

    function initBoard(selectedPuzzle, selectedSolution) {
      puzzle = selectedPuzzle;
      solution = selectedSolution;

      board.innerHTML = '';
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          createCell(r, c, puzzle[r][c]);
        }
      }

      updateHighlights(); // 初始化時同步更新高亮與筆記黑體
    }

    function enableNotes(cell) {
      if (!cell.querySelector('.notes')) {
        const notes = document.createElement('div');
        notes.className = 'notes';
        for (let i = 1; i <= 9; i++) {
          const note = document.createElement('div');
          note.textContent = '';
          notes.appendChild(note);
        }
        cell.appendChild(notes);
      }
    }

    function toggleNote(cell, number) {
      enableNotes(cell);
      const notes = cell.querySelector('.notes');
      const index = number - 1;
      const current = notes.children[index].textContent;
      notes.children[index].textContent = current === '' ? number : '';
    }

    function removeNotesAround(cell, number) {
      const r = parseInt(cell.dataset.row);
      const c = parseInt(cell.dataset.col);
      document.querySelectorAll('.cell').forEach(other => {
        const or = parseInt(other.dataset.row);
        const oc = parseInt(other.dataset.col);
        const inSameRow = or === r;
        const inSameCol = oc === c;
        const inSameBlock =
          Math.floor(or / 3) === Math.floor(r / 3) &&
          Math.floor(oc / 3) === Math.floor(c / 3);

        if ((inSameRow || inSameCol || inSameBlock) && 
            (!other.dataset.value || other.classList.contains("error"))) {
          const notes = other.querySelector('.notes');
          if (notes) {
            [...notes.children].forEach(n => {
              if (n.textContent == number) n.textContent = '';
            });
          }
        }
      });
    }

    numberPad.addEventListener('click', e => {
      const num = parseInt(e.target.dataset.num);
      if (!num || !selectedCell) return;
      handleNumberInput(num);
    });

    document.addEventListener('keydown', e => {
      if (!selectedCell) return;
      const num = parseInt(e.key);
      if (num >= 1 && num <= 9) {
        handleNumberInput(num);
      }
    });

    noteModeBtn.addEventListener('click', () => {
      isNoteMode = !isNoteMode;
      noteModeBtn.classList.toggle('active', isNoteMode);
      updateHighlights();
    });

    function fillAllNotes() {
      document.querySelectorAll('.cell').forEach(cell => {
        if (!cell.dataset.value || cell.dataset.value === '' || cell.classList.contains("error")) {
          const r = parseInt(cell.dataset.row);
          const c = parseInt(cell.dataset.col);

          const existingInRow = new Set();
          const existingInCol = new Set();
          const existingInBlock = new Set();

          for (let i = 0; i < 9; i++) {
            const rowCell = document.querySelector(`.cell[data-row="${r}"][data-col="${i}"]:not(.error)`);
            const colCell = document.querySelector(`.cell[data-row="${i}"][data-col="${c}"]:not(.error)`);
            if (rowCell && rowCell.dataset.value) existingInRow.add(+rowCell.dataset.value);
            if (colCell && colCell.dataset.value) existingInCol.add(+colCell.dataset.value);
          }

          const startRow = Math.floor(r / 3) * 3;
          const startCol = Math.floor(c / 3) * 3;
          for (let dr = 0; dr < 3; dr++) {
            for (let dc = 0; dc < 3; dc++) {
              const blockCell = document.querySelector(`.cell[data-row="${startRow + dr}"][data-col="${startCol + dc}"]:not(.error)`);
              if (blockCell && blockCell.dataset.value) {
                existingInBlock.add(+blockCell.dataset.value);
              }
            }
          }

          const allowed = [];
          for (let num = 1; num <= 9; num++) {
            if (!existingInRow.has(num) && !existingInCol.has(num) && !existingInBlock.has(num)) {
              allowed.push(num);
            }
          }

          // 填入筆記
          if (!cell.querySelector('.notes')) {
            const notes = document.createElement('div');
            notes.className = 'notes';
            for (let i = 1; i <= 9; i++) {
              const note = document.createElement('div');
              note.textContent = allowed.includes(i) ? i : '';
              notes.appendChild(note);
            }
            cell.appendChild(notes);
          } else {
            const notes = cell.querySelector('.notes');
            for (let i = 1; i <= 9; i++) {
              notes.children[i - 1].textContent = allowed.includes(i) ? i : '';
            }
          }
        }
      });
    }

    function removeAllNotes() {
      document.querySelectorAll('.cell').forEach(cell => {
        if (!cell.dataset.value || cell.dataset.value === '' || cell.classList.contains("error")) {
          const r = parseInt(cell.dataset.row);
          const c = parseInt(cell.dataset.col);

          if (cell.querySelector('.notes')) {
            const notes = cell.querySelector('.notes');
            for (let i = 1; i <= 9; i++) {
              notes.children[i - 1].textContent = '';
            }
          }
        }
      });
    }

    function updateHighlights() {
      // 先清除所有 highlight 和 notes 粗體
      document.querySelectorAll('.cell').forEach(cell => {
        cell.classList.remove('highlight', 'note-mode');
        if (isNoteMode && !cell.classList.contains('filled')) {
          cell.classList.add('note-mode');
        }
        const notes = cell.querySelector('.notes');
        if (notes) {
          [...notes.children].forEach(note => {
            note.style.fontWeight = '';
            note.classList.remove("unique-note");
          });
        }
        updateSingleNoteStyle(cell);
      });
      updateNumberPad();

      if (!selectedCell) return;

      const selectedValue = selectedCell.dataset.value;
      if (selectedValue) {
        document.querySelectorAll('.cell').forEach(cell => {
          if (cell.dataset.value === selectedValue) {
            cell.classList.add('highlight');
          }
          const notes = cell.querySelector('.notes');
          if (notes) {
            const r = parseInt(cell.dataset.row);
            const c = parseInt(cell.dataset.col);
            [...notes.children].forEach(note => {
              if (note.textContent === selectedValue) {
                note.style.fontWeight = 'bold';
                const isUnique = isNoteUniqueInRegion(r, c, parseInt(note.textContent));
                if (isUnique) {
                  note.classList.add("unique-note");
                }
              }
            });
          }
        });
      }
    }

    function isNoteUniqueInRegion(row, col, number) {
      const inRowRegion = [];
      const inColRegion = [];
      const inBlockRegion = [];

      document.querySelectorAll('.cell').forEach(cell => {
        const r = parseInt(cell.dataset.row);
        const c = parseInt(cell.dataset.col);

        const inSameRow = r === row;
        const inSameCol = c === col;
        const inSameBlock =
          Math.floor(r / 3) === Math.floor(row / 3) &&
          Math.floor(c / 3) === Math.floor(col / 3);

        if (inSameRow) inRowRegion.push(cell);
        if (inSameCol) inColRegion.push(cell);
        if (inSameBlock) inBlockRegion.push(cell);
      });

      return getRegionNoteNumberCount(inRowRegion, number) === 1 ||
            getRegionNoteNumberCount(inColRegion, number) === 1 ||
            getRegionNoteNumberCount(inBlockRegion, number) === 1;
    }

    function getRegionNoteNumberCount(inRegion, number){
      let count = 0;
      inRegion.forEach(cell => {
        const notes = cell.querySelector('.notes');
        if (notes && notes.children[number - 1].textContent === number.toString()) {
          count++;
        }
      });

      return count;
    }

    const fillNotesBtn = document.getElementById('fillNotesBtn');
    fillNotesBtn.addEventListener('click', () => {
      fillAllNotes();
      updateHighlights();
    });

    const removeAllNotesBtn = document.getElementById('removeAllNotesBtn');
    removeAllNotesBtn.addEventListener('click', () => {
      removeAllNotes();
      updateHighlights();
    });

    const pauseBtn = document.getElementById('pauseBtn');
    pauseBtn.addEventListener('click', () => {
      let currentTimeDiff = getCurrentTimeDiff();
      clearInterval(timerInterval);
      showPopup({
        title: "暫停遊戲", 
        content: "稍微休息一下吧！",
        buttons: [
          {
            text: "回到遊戲", 
            onClick: () => {
              startTimer(Date.now() - currentTimeDiff * 1000);
              return false;
            }
          }
        ]});
    });

    function updateNumberPad() {
      const count = Array(10).fill(0);
      document.querySelectorAll('.cell').forEach(cell => {
        const val = parseInt(cell.dataset.value);
        if (val >= 1 && val <= 9) count[val]++;
      });

      document.querySelectorAll('#number-pad button').forEach(btn => {
        const num = parseInt(btn.dataset.num);
        if (count[num] === 9) {
          btn.style.background = '#c8e6c9'; // 淺綠色
          btn.style.color = 'black';
        } else {
          btn.style.background = ''; // 還原
          btn.style.color = '';
        }
      });
    }

    function checkWin() {
      const allCells = document.querySelectorAll('.cell');
      for (const cell of allCells) {
        if (!cell.dataset.value || cell.classList.contains('error')) {
          return false;
        }
      }
      setTimeout(showWinOverlay, 100);
      return true;
    }

    function showWinOverlay() {
      saveSudokuResult(mode, puzzle, solution, errorCount, getCurrentTimeDiff());
      showPopup({
        title: "恭喜完成！",
        content: "你成功完成了這個挑戰！",
        buttons: [
          { text: "回主頁", onClick: () => { goToScene(main); return false; } },
        ]
      });
    }

    function generateSudokuSolution() {
      const board = Array.from({ length: 9 }, () => Array(9).fill(0));

      function isValid(board, row, col, num) {
        for (let i = 0; i < 9; i++) {
          if (board[row][i] === num || board[i][col] === num) return false;
          const boxRow = 3 * Math.floor(row / 3) + Math.floor(i / 3);
          const boxCol = 3 * Math.floor(col / 3) + i % 3;
          if (board[boxRow][boxCol] === num) return false;
        }
        return true;
      }

      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(randomFunc() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function fillBoard(row = 0, col = 0) {
        if (row === 9) return true;
        const [nextRow, nextCol] = col === 8 ? [row + 1, 0] : [row, col + 1];

        const numbers = shuffle([...Array(9).keys()].map(n => n + 1));
        for (let num of numbers) {
          if (isValid(board, row, col, num)) {
            board[row][col] = num;
            if (fillBoard(nextRow, nextCol)) return true;
            board[row][col] = 0;
          }
        }
        return false;
      }

      fillBoard();
      const solution = board.map(row => [...row]);
      return solution;
    }

    function hasUniqueSolution(puzzle) {
      let count = 0;

      function isValid(board, row, col, num) {
        for (let i = 0; i < 9; i++) {
          if (board[row][i] === num || board[i][col] === num) return false;
          const boxRow = 3 * Math.floor(row / 3) + Math.floor(i / 3);
          const boxCol = 3 * Math.floor(col / 3) + i % 3;
          if (board[boxRow][boxCol] === num) return false;
        }
        return true;
      }

      function solve(board, row = 0, col = 0) {
        if (row === 9) {
          count++;
          return count < 2; // 如果找到兩個以上就停止
        }
        const [nextRow, nextCol] = col === 8 ? [row + 1, 0] : [row, col + 1];
        if (board[row][col] !== 0) return solve(board, nextRow, nextCol);

        for (let num = 1; num <= 9; num++) {
          if (isValid(board, row, col, num)) {
            board[row][col] = num;
            if (!solve(board, nextRow, nextCol)) {
              board[row][col] = 0;
              return false;
            }
            board[row][col] = 0;
          }
        }
        return true;
      }

      const boardCopy = puzzle.map(row => [...row]);
      solve(boardCopy);
      return count === 1;
    }

    function digHoles(puzzle, solution) {
      const puzzleCopy = puzzle.map(row => [...row]);

      let attempts = 0;
      while (attempts < 100) {
        const row = Math.floor(randomFunc() * 9);
        const col = Math.floor(randomFunc() * 9);
        if (puzzleCopy[row][col] === 0) {
          attempts++;
          continue;
        }

        const backup = puzzleCopy[row][col];
        puzzleCopy[row][col] = 0;

        if (!hasUniqueSolution(puzzleCopy)) {
          puzzleCopy[row][col] = backup;
        }

        attempts++;
      }

      return puzzleCopy;
    }

    function generateSudokuPuzzleWithUniqueSolution() {
      const full = generateSudokuSolution(); // 產出完整填滿盤面
      const puzzle = digHoles(full, full); // 拿掉 40 格，保證唯一解
      return {
        puzzle,
        solution: full,
      };
    }

    function handleNumberInput(num) {
      if (!selectedCell || selectedCell.classList.contains('filled')) return;

      if (isNoteMode) {
        if (selectedCell.classList.contains('locked')) return;
        toggleNote(selectedCell, num);

        let valueDiv = selectedCell.querySelector('.value');
        if (valueDiv) {
          valueDiv.textContent = '';
          selectedCell.dataset.value = null;
        }
        return;
      }

      const r = parseInt(selectedCell.dataset.row);
      const c = parseInt(selectedCell.dataset.col);
      const correct = solution[r][c];

      let valueDiv = selectedCell.querySelector('.value');
      if (!valueDiv) {
        valueDiv = document.createElement('div');
        valueDiv.className = 'value user';
        selectedCell.appendChild(valueDiv);
      } else {
        valueDiv.classList.add('user');
      }
      valueDiv.textContent = num;
      selectedCell.dataset.value = num;

      if (num === correct) {
        selectedCell.classList.add("filled");
        selectedCell.classList.remove("error");
        removeNotesAround(selectedCell, num);
        const notes = selectedCell.querySelector('.notes');
        if (notes) selectedCell.removeChild(notes);
      } else {
        selectedCell.classList.add("error");
        errorCount++;
        errorDisplay.textContent = errorCount;
        errorDisplay.setAttribute("data-content", errorCount);
      }

      updateHighlights();
      checkWin();
    }

    function updateSingleNoteStyle(cell) {
      const notes = cell.querySelector('.notes');
      if (!notes) return;
      const filled = Array.from(notes.children).filter(n => n.textContent !== '');
      notes.querySelectorAll('div').forEach(div => div.classList.remove('single'));
      if (filled.length === 1) {
        filled[0].classList.add('single');
      }
    }

    function startNewGame(specifiedPuzzle){
      const { puzzle, solution } = specifiedPuzzle 
        ? { puzzle: specifiedPuzzle, solution: solveSudoku(specifiedPuzzle) }
        : generateSudokuPuzzleWithUniqueSolution();
      selectedCell = null;
      initBoard(puzzle, solution);

      errorCount = 0;
      errorDisplay.textContent = 0;
      errorDisplay.setAttribute("data-content", 0);
      timerDisplay.textContent = '00:00';
      startTimer();
    }

    function getCurrentTimeDiff()
    {
      return Math.floor((Date.now() - startTime) / 1000);
    }

    function startTimer(specifiedStartTime) {
      startTime = specifiedStartTime !== undefined
        ? specifiedStartTime
        : Date.now();
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const diff = getCurrentTimeDiff();
        const min = String(Math.floor(diff / 60)).padStart(2, '0');
        const sec = String(diff % 60).padStart(2, '0');
        timerDisplay.textContent = `${min}:${sec}`;
      }, 1000);
    }

    function solveSudoku(input) {
      const board = input.map(row => [...row]); // 深拷貝

      function findEmpty(board) {
        for (let r = 0; r < 9; r++) {
          for (let c = 0; c < 9; c++) {
            if (board[r][c] === 0) return [r, c];
          }
        }
        return null;
      }

      function isValid(board, num, row, col) {
        for (let i = 0; i < 9; i++) {
          if (board[row][i] === num || board[i][col] === num) return false;
        }

        const boxRow = Math.floor(row / 3) * 3;
        const boxCol = Math.floor(col / 3) * 3;
        for (let i = 0; i < 3; i++) {
          for (let j = 0; j < 3; j++) {
            if (board[boxRow + i][boxCol + j] === num) return false;
          }
        }

        return true;
      }

      function solve(board) {
        const pos = findEmpty(board);
        if (!pos) return true;

        const [row, col] = pos;
        for (let num = 1; num <= 9; num++) {
          if (isValid(board, num, row, col)) {
            board[row][col] = num;
            if (solve(board)) return true;
            board[row][col] = 0;
          }
        }

        return false;
      }

      return solve(board) ? board : null;
    }

    function loadSaveData()
    {
      const raw = localStorage.getItem("sudoku_results");
      return raw ? JSON.parse(raw) : { today: {}, free: [], custom: [] };
    }

    function saveSudokuResult(mode, puzzle, solution, errors, timeInSeconds) {
      const solvedAt = Math.floor(Date.now() / 1000); // Unix timestamp
      const record = { puzzle, solution, errors, time: timeInSeconds, solvedAt };

      let data = loadSaveData();
      if (mode === TODAY_MODE) {
        data.today[cachedToday] = record;
      } else if (mode === FREE_MODE) {
        data.free.push(record);
      } else if (mode === CUSTOM_MODE) {
        data.custom.push(record);
      }

      localStorage.setItem("sudoku_results", JSON.stringify(data));
    }

    function showPopup({ title = "", content = "", buttons = [] }) {
      const popup = document.getElementById("general-popup");
      const titleEl = document.getElementById("popup-title");
      const contentEl = document.getElementById("popup-content");
      const buttonsEl = document.getElementById("popup-buttons");

      titleEl.textContent = title;
      contentEl.innerHTML = content;

      buttonsEl.innerHTML = "";
      buttons.forEach(({ text, onClick }) => {
        const btn = document.createElement("button");
        btn.textContent = text;
        btn.classList.add("fancy-button");
        btn.onclick = () => {
          playClickSound();
          let shouldKeepStay = onClick?.();
          if (!shouldKeepStay) hidePopup();
        };
        buttonsEl.appendChild(btn);
      });

      popup.style.display = "flex";
    }

    async function hidePopup() {
      let generalPopup = document.getElementById("general-popup");
      generalPopup.classList.add("leave");
      await wait(500);
      generalPopup.style.display = "none";
      generalPopup.classList.remove("leave");
    }

    async function renderAchievements() {
      await goToScene(achievements);
      let tabs = document.getElementsByClassName("tab-btn");
      selectAchievementTab(tabs[0]);
    }


    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      return `${min}:${sec.toString().padStart(2, "0")}`;
    }

    function formatDate(timestamp) {
      const d = new Date(timestamp * 1000);
      return d.toISOString().split("T")[0];
    }

    function loadStatisticsPage() {
      const stats = computeStatisticsFromStorage();
      document.getElementById("stat-total").textContent = stats.total;
      document.getElementById("stat-perfect").textContent = stats.perfect;
      document.getElementById("stat-min-time").textContent = formatTime(stats.minTime);
      document.getElementById("stat-max-time").textContent = formatTime(stats.maxTime);
      document.getElementById("stat-avg-time").textContent = formatTime(stats.avgTime);
      document.getElementById("stat-min-errors").textContent = stats.minErrors;
      document.getElementById("stat-max-errors").textContent = stats.maxErrors;
      document.getElementById("stat-avg-errors").textContent = stats.avgErrors;
    }

    function computeStatisticsFromStorage() {
      const data = loadSaveData();
      const allRecords = [];

      if (data && data.today) {
        Object.values(data.today).forEach(r => allRecords.push(r));
      }

      ["free", "custom"].forEach(mode => {
        if (data && Array.isArray(data[mode])) {
          allRecords.push(...data[mode]);
        }
      });

      const total = allRecords.length;
      const perfect = allRecords.filter(r => r.errors === 0).length;
      const times = allRecords.map(r => r.time);
      const errors = allRecords.map(r => r.errors);

      const minTime = times.length === 0
        ? 0
        : Math.min(...times);
      const maxTime = times.length === 0
        ? 0
        : Math.max(...times);
      const avgTime = times.length === 0
        ? 0
        : Math.round(times.reduce((a, b) => a + b, 0) / times.length);

      const minErrors = errors.length === 0
        ? 0
        : Math.min(...errors);
      const maxErrors = errors.length === 0
        ? 0
        : Math.max(...errors);
      const avgErrors = errors.length === 0
        ? 0
        : (errors.reduce((a, b) => a + b, 0) / errors.length).toFixed(2);

      return {
        total,
        perfect,
        minTime,
        maxTime,
        avgTime,
        minErrors,
        maxErrors,
        avgErrors,
      };
    }

    const loadedTabs = new Set();
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        selectAchievementTab(btn);
      });
    });

    function selectAchievementTab(btn) {
      // 切換 active 樣式
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        // 切換顯示區塊
        const target = btn.dataset.tab;
        document.querySelectorAll(".achievement-section").forEach(sec => {
          sec.style.display = "none";
        });
        document.getElementById(`${target}-section`).style.display = "block";

        // 根據 tab 載入內容
        if (target === "stats") {
          loadStatisticsPage(); // 原有統計邏輯
        } else if (!loadedTabs.has(target)) {
          renderAchievementTab(target); // 新增懶加載成就
          loadedTabs.add(target);
        }
    }

    document.querySelectorAll(".achievement-section").forEach((sec, idx) => {
      sec.style.display = idx === 0 ? "block" : "none";
    });

    function createAchievementItem(record, mode, recordTodayDate) {
      const container = document.createElement("div");
      container.className = "record-item";

      // 1. Mini Sudoku Grid
      const grid = document.createElement("div");
      grid.className = "mini-sudoku";

      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          const cell = document.createElement("div");
          const val = record.puzzle[row][col];
          if (val !== 0) {
            cell.textContent = val;
            cell.style.color = "#000";
          } else {
            cell.textContent = record.solution[row][col];
            cell.style.color = "#2196f3"
          }
          grid.appendChild(cell);
        }
      }

      // 2. Right Side Info
      const info = document.createElement("div");
      info.className = "info";

      const date = mode === "today"
        ? new Date(recordTodayDate)
        : new Date(record.solvedAt * 1000);
      const dateStr = `${date.getFullYear()} 年 ${date.getMonth() + 1} 月 ${date.getDate()} 日`;

      const timeStr = `<i class="ph ph-timer"></i> 時間：${Math.floor(+record.time / 60)}:${(+record.time % 60)
        .toString()
        .padStart(2, "0")}`;
      const errorStr = `<i class="ph ph-x-circle"></i> 錯誤：${record.errors}`;
      const solvedAtStr = `<i class="ph ph-flag-checkered"></i> 完成於 ${new Date(record.solvedAt * 1000).toLocaleString("zh-TW")}`;

      const titleEl = document.createElement("div");
      titleEl.className = "title";
      titleEl.innerHTML = dateStr;

      const timeEl = document.createElement("div");
      timeEl.innerHTML = timeStr;

      const errorEl = document.createElement("div");
      errorEl.innerHTML = errorStr;

      const solvedAtEl = document.createElement("div");
      solvedAtEl.innerHTML = solvedAtStr;

      const replayBtn = document.createElement("button");
      replayBtn.className = "fancy-button";
      replayBtn.textContent = "重新遊玩";
      replayBtn.onclick = () => {
        startPuzzle(CUSTOM_MODE, record.puzzle);
      };

      info.append(titleEl, timeEl, errorEl, solvedAtEl, replayBtn);

      container.append(grid, info);
      return container;
    }

    function renderAchievementTab(tabName) {
      const data = loadSaveData();
      let listEl = document.getElementById(`${tabName}-list`);
      listEl.innerHTML = ""; // 保險清空一下

      if (tabName === "today") {
        for (const [date, record] of Object.entries(data.today || {}).reverse()) {
          listEl.appendChild(createAchievementItem(record, "today", date));
        }
      } else {
        for (const record of (data[tabName] || []).reverse()) {
          listEl.appendChild(createAchievementItem(record, tabName));
        }
      }
    }
  </script>
</body>
</html>